(()=>{console.log("CloakForge - Privacy \u2022 Security \u2022 Freedom");var F=[],d,v,o,l,i,m;document.addEventListener("DOMContentLoaded",function(){let e=document.getElementById("search-input"),t=document.querySelector(".search-filters"),a=document.querySelector(".search-container"),n=document.getElementById("search-btn"),s=document.getElementById("search-results"),r=document.getElementById("category-filter"),h=document.getElementById("tag-filter"),g=document.getElementById("section-filter"),f=[];e.addEventListener("focus",function(){t&&(t.classList.add("show"),a.classList.add("filters-active"))}),document.addEventListener("click",function(c){!(c.target.closest(".search-container")||c.target.closest(".search-filters"))&&t&&(e.value.trim()||(t.classList.remove("show"),a.classList.remove("filters-active")))}),d&&s&&(fetch("/index.json").then(c=>{if(!c.ok)throw new Error(`HTTP error! status: ${c.status}`);return c.json()}).then(c=>{f=c,console.log("Search index loaded:",f.length,"items"),populateFilters()}).catch(c=>(console.error("Error loading search index:",c),fetch("./index.json").then(u=>{if(!u.ok)throw new Error(`HTTP error! status: ${u.status}`);return u.json()}).then(u=>{f=u,console.log("Search index loaded (alternative path):",f.length,"items"),populateFilters()}).catch(u=>{console.error("Error loading search index from alternative path:",u),s.innerHTML='<div class="alert alert-warning">Search functionality is currently unavailable. Please try again later.</div>'}))),d.addEventListener("input",p),d.addEventListener("focus",M),r&&r.addEventListener("change",p),h&&h.addEventListener("change",p),g&&g.addEventListener("change",p),m&&m.addEventListener("click",A),document.addEventListener("click",function(c){!d.contains(c.target)&&!s.contains(c.target)&&y()}),d.addEventListener("keydown",R))});function p(e){let t=d.value.trim().toLowerCase(),a=o?o.value:"",n=l?l.value:"",s=i?i.value:"";if(w(),t.length>=2||a||n||s){let r=L(t,a,n,s);$(r,t)}else y()}function M(){let e=d.value.trim().toLowerCase(),t=o?o.value:"",a=l?l.value:"",n=i?i.value:"";if(e.length>=2||t||a||n){let s=L(e,t,a,n);$(s,e)}}function L(e,t,a,n){return F.filter(s=>{let r=!0;if(e.length>=2){let c=s.title.toLowerCase().includes(e),u=s.content.toLowerCase().includes(e),C=s.summary.toLowerCase().includes(e),k=s.tags&&s.tags.some(S=>S.toLowerCase().includes(e)),x=s.categories&&s.categories.toLowerCase().includes(e);r=c||u||C||k||x}let h=!0;t&&(h=s.categories===t);let g=!0;a&&(g=s.tags&&s.tags.includes(a));let f=!0;return n&&(f=s.section===n),r&&h&&g&&f}).slice(0,12)}function $(e,t){let a=b(),n=a.length>0?`<div class="search-filter-summary">Filtered by: ${a.join(", ")}</div>`:"";if(e.length===0){let s=t?`No results found for "${t}"`:"No results match the selected filters";v.innerHTML=`
            ${n}
            <div class="search-no-results">
                ${s}
            </div>
        `}else{let s=e.length===1?"result":"results";v.innerHTML=`
            ${n}
            <div class="search-results-count">${e.length} ${s} found</div>
            ${e.map(r=>`
                <div class="search-result-item" onclick="window.location.href='${r.href}'">
                    <div class="search-result-title">${E(r.title,t)}</div>
                    <div class="search-result-summary">${E(T(r.summary,120),t)}</div>
                    <div class="search-result-meta">
                        <span class="search-result-section">${r.section}</span>
                        ${r.categories?`<span class="text-muted">${r.categories}</span>`:""}
                        ${r.tags?r.tags.slice(0,3).map(h=>`<span class="search-tag">#${h}</span>`).join(""):""}
                    </div>
                </div>
            `).join("")}
        `}I()}function b(){let e=[];return o&&o.value&&e.push(`Category: ${o.value}`),l&&l.value&&e.push(`Tag: #${l.value}`),i&&i.value&&e.push(`Section: ${i.value}`),e}function w(){if(m){let e=o&&o.value||l&&l.value||i&&i.value;m.disabled=!e,[o,l,i].forEach(t=>{t&&(t.value?t.classList.add("filter-active"):t.classList.remove("filter-active"))})}}function A(){o&&(o.value=""),l&&(l.value=""),i&&(i.value=""),w(),p()}function E(e,t){if(!e||!t)return e;let a=new RegExp(`(${B(t)})`,"gi");return e.replace(a,'<mark style="background-color: var(--accent-tertiary); color: var(--text-primary); padding: 0 2px; border-radius: 2px;">$1</mark>')}function T(e,t){return!e||e.length<=t?e:e.substring(0,t).trim()+"..."}function B(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function I(){v.style.display="block"}function y(){v.style.display="none"}function R(e){let t=v.querySelectorAll(".search-result-item"),a=v.querySelector(".search-result-item.active"),n=-1;switch(a&&(n=Array.from(t).indexOf(a)),e.key){case"ArrowDown":e.preventDefault(),n<t.length-1&&(a&&a.classList.remove("active"),t[n+1].classList.add("active"));break;case"ArrowUp":e.preventDefault(),n>0&&(a&&a.classList.remove("active"),t[n-1].classList.add("active"));break;case"Enter":e.preventDefault(),a&&a.click();break;case"Escape":y(),d.blur();break}}})();
