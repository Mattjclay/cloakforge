(()=>{console.log("CloakForge - Privacy \u2022 Security \u2022 Freedom");var C=[],u,h,r,o,i,p,L=new Set,$=new Set;document.addEventListener("DOMContentLoaded",function(){let e=document.getElementById("search-input"),t=document.querySelector(".search-filters"),s=document.querySelector(".search-container"),n=document.getElementById("search-btn"),a=document.getElementById("search-results"),c=document.getElementById("category-filter"),d=document.getElementById("tag-filter"),f=document.getElementById("section-filter"),v=[];e.addEventListener("focus",function(){t&&(t.classList.add("show"),s.classList.add("filters-active"))}),document.addEventListener("click",function(l){!(l.target.closest(".search-container")||l.target.closest(".search-filters"))&&t&&(e.value.trim()||(t.classList.remove("show"),s.classList.remove("filters-active")))}),u&&a&&(fetch("/index.json").then(l=>l.json()).then(l=>{v=l,console.log("Search index loaded:",v.length,"items"),A()}).catch(l=>{console.error("Error loading search index:",l)}),u.addEventListener("input",g),u.addEventListener("focus",B),c&&c.addEventListener("change",g),d&&d.addEventListener("change",g),f&&f.addEventListener("change",g),p&&p.addEventListener("click",R),document.addEventListener("click",function(l){!u.contains(l.target)&&!a.contains(l.target)&&y()}),u.addEventListener("keydown",D))});function A(){C.forEach(e=>{e.categories&&L.add(e.categories),e.tags&&Array.isArray(e.tags)&&e.tags.forEach(t=>$.add(t))}),r&&Array.from(L).sort().forEach(e=>{let t=document.createElement("option");t.value=e,t.textContent=e,r.appendChild(t)}),o&&Array.from($).sort().forEach(e=>{let t=document.createElement("option");t.value=e,t.textContent=`#${e}`,o.appendChild(t)}),m()}function g(e){let t=u.value.trim().toLowerCase(),s=r?r.value:"",n=o?o.value:"",a=i?i.value:"";if(m(),t.length>=2||s||n||a){let c=k(t,s,n,a);S(c,t)}else y()}function B(){let e=u.value.trim().toLowerCase(),t=r?r.value:"",s=o?o.value:"",n=i?i.value:"";if(e.length>=2||t||s||n){let a=k(e,t,s,n);S(a,e)}}function k(e,t,s,n){return C.filter(a=>{let c=!0;if(e.length>=2){let l=a.title.toLowerCase().includes(e),E=a.content.toLowerCase().includes(e),x=a.summary.toLowerCase().includes(e),F=a.tags&&a.tags.some(b=>b.toLowerCase().includes(e)),M=a.categories&&a.categories.toLowerCase().includes(e);c=l||E||x||F||M}let d=!0;t&&(d=a.categories===t);let f=!0;s&&(f=a.tags&&a.tags.includes(s));let v=!0;return n&&(v=a.section===n),c&&d&&f&&v}).slice(0,12)}function S(e,t){let s=I(),n=s.length>0?`<div class="search-filter-summary">Filtered by: ${s.join(", ")}</div>`:"";if(e.length===0){let a=t?`No results found for "${t}"`:"No results match the selected filters";h.innerHTML=`
            ${n}
            <div class="search-no-results">
                ${a}
            </div>
        `}else{let a=e.length===1?"result":"results";h.innerHTML=`
            ${n}
            <div class="search-results-count">${e.length} ${a} found</div>
            ${e.map(c=>`
                <div class="search-result-item" onclick="window.location.href='${c.href}'">
                    <div class="search-result-title">${w(c.title,t)}</div>
                    <div class="search-result-summary">${w(T(c.summary,120),t)}</div>
                    <div class="search-result-meta">
                        <span class="search-result-section">${c.section}</span>
                        ${c.categories?`<span class="text-muted">${c.categories}</span>`:""}
                        ${c.tags?c.tags.slice(0,3).map(d=>`<span class="search-tag">#${d}</span>`).join(""):""}
                    </div>
                </div>
            `).join("")}
        `}j()}function I(){let e=[];return r&&r.value&&e.push(`Category: ${r.value}`),o&&o.value&&e.push(`Tag: #${o.value}`),i&&i.value&&e.push(`Section: ${i.value}`),e}function m(){if(p){let e=r&&r.value||o&&o.value||i&&i.value;p.disabled=!e,[r,o,i].forEach(t=>{t&&(t.value?t.classList.add("filter-active"):t.classList.remove("filter-active"))})}}function R(){r&&(r.value=""),o&&(o.value=""),i&&(i.value=""),m(),g()}function w(e,t){if(!e||!t)return e;let s=new RegExp(`(${V(t)})`,"gi");return e.replace(s,'<mark style="background-color: var(--accent-tertiary); color: var(--text-primary); padding: 0 2px; border-radius: 2px;">$1</mark>')}function T(e,t){return!e||e.length<=t?e:e.substring(0,t).trim()+"..."}function V(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function j(){h.style.display="block"}function y(){h.style.display="none"}function D(e){let t=h.querySelectorAll(".search-result-item"),s=h.querySelector(".search-result-item.active"),n=-1;switch(s&&(n=Array.from(t).indexOf(s)),e.key){case"ArrowDown":e.preventDefault(),n<t.length-1&&(s&&s.classList.remove("active"),t[n+1].classList.add("active"));break;case"ArrowUp":e.preventDefault(),n>0&&(s&&s.classList.remove("active"),t[n-1].classList.add("active"));break;case"Enter":e.preventDefault(),s&&s.click();break;case"Escape":y(),u.blur();break}}})();
