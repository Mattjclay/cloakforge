(()=>{console.log("CloakForge - Privacy \u2022 Security \u2022 Freedom");var w=[],u,h,o,l,i,g,E=new Set,L=new Set;document.addEventListener("DOMContentLoaded",function(){let e=document.getElementById("search-input"),t=document.querySelector(".search-filters"),s=document.getElementById("search-btn"),n=document.getElementById("search-results"),a=document.getElementById("category-filter"),c=document.getElementById("tag-filter"),d=document.getElementById("section-filter"),f=[];e.addEventListener("focus",function(){t&&t.classList.add("show")}),document.addEventListener("click",function(r){!(r.target.closest(".search-container")||r.target.closest(".search-filters"))&&t&&(e.value.trim()||t.classList.remove("show"))}),u&&n&&(fetch("/index.json").then(r=>r.json()).then(r=>{f=r,console.log("Search index loaded:",f.length,"items"),A()}).catch(r=>{console.error("Error loading search index:",r)}),u.addEventListener("input",v),u.addEventListener("focus",B),a&&a.addEventListener("change",v),c&&c.addEventListener("change",v),d&&d.addEventListener("change",v),g&&g.addEventListener("click",R),document.addEventListener("click",function(r){!u.contains(r.target)&&!n.contains(r.target)&&m()}),u.addEventListener("keydown",D))});function A(){w.forEach(e=>{e.categories&&E.add(e.categories),e.tags&&Array.isArray(e.tags)&&e.tags.forEach(t=>L.add(t))}),o&&Array.from(E).sort().forEach(e=>{let t=document.createElement("option");t.value=e,t.textContent=e,o.appendChild(t)}),l&&Array.from(L).sort().forEach(e=>{let t=document.createElement("option");t.value=e,t.textContent=`#${e}`,l.appendChild(t)}),p()}function v(e){let t=u.value.trim().toLowerCase(),s=o?o.value:"",n=l?l.value:"",a=i?i.value:"";if(p(),t.length>=2||s||n||a){let c=C(t,s,n,a);k(c,t)}else m()}function B(){let e=u.value.trim().toLowerCase(),t=o?o.value:"",s=l?l.value:"",n=i?i.value:"";if(e.length>=2||t||s||n){let a=C(e,t,s,n);k(a,e)}}function C(e,t,s,n){return w.filter(a=>{let c=!0;if(e.length>=2){let y=a.title.toLowerCase().includes(e),x=a.content.toLowerCase().includes(e),F=a.summary.toLowerCase().includes(e),S=a.tags&&a.tags.some(b=>b.toLowerCase().includes(e)),M=a.categories&&a.categories.toLowerCase().includes(e);c=y||x||F||S||M}let d=!0;t&&(d=a.categories===t);let f=!0;s&&(f=a.tags&&a.tags.includes(s));let r=!0;return n&&(r=a.section===n),c&&d&&f&&r}).slice(0,12)}function k(e,t){let s=I(),n=s.length>0?`<div class="search-filter-summary">Filtered by: ${s.join(", ")}</div>`:"";if(e.length===0){let a=t?`No results found for "${t}"`:"No results match the selected filters";h.innerHTML=`
            ${n}
            <div class="search-no-results">
                ${a}
            </div>
        `}else{let a=e.length===1?"result":"results";h.innerHTML=`
            ${n}
            <div class="search-results-count">${e.length} ${a} found</div>
            ${e.map(c=>`
                <div class="search-result-item" onclick="window.location.href='${c.href}'">
                    <div class="search-result-title">${$(c.title,t)}</div>
                    <div class="search-result-summary">${$(T(c.summary,120),t)}</div>
                    <div class="search-result-meta">
                        <span class="search-result-section">${c.section}</span>
                        ${c.categories?`<span class="text-muted">${c.categories}</span>`:""}
                        ${c.tags?c.tags.slice(0,3).map(d=>`<span class="search-tag">#${d}</span>`).join(""):""}
                    </div>
                </div>
            `).join("")}
        `}j()}function I(){let e=[];return o&&o.value&&e.push(`Category: ${o.value}`),l&&l.value&&e.push(`Tag: #${l.value}`),i&&i.value&&e.push(`Section: ${i.value}`),e}function p(){if(g){let e=o&&o.value||l&&l.value||i&&i.value;g.disabled=!e,[o,l,i].forEach(t=>{t&&(t.value?t.classList.add("filter-active"):t.classList.remove("filter-active"))})}}function R(){o&&(o.value=""),l&&(l.value=""),i&&(i.value=""),p(),v()}function $(e,t){if(!e||!t)return e;let s=new RegExp(`(${V(t)})`,"gi");return e.replace(s,'<mark style="background-color: var(--accent-tertiary); color: var(--text-primary); padding: 0 2px; border-radius: 2px;">$1</mark>')}function T(e,t){return!e||e.length<=t?e:e.substring(0,t).trim()+"..."}function V(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function j(){h.style.display="block"}function m(){h.style.display="none"}function D(e){let t=h.querySelectorAll(".search-result-item"),s=h.querySelector(".search-result-item.active"),n=-1;switch(s&&(n=Array.from(t).indexOf(s)),e.key){case"ArrowDown":e.preventDefault(),n<t.length-1&&(s&&s.classList.remove("active"),t[n+1].classList.add("active"));break;case"ArrowUp":e.preventDefault(),n>0&&(s&&s.classList.remove("active"),t[n-1].classList.add("active"));break;case"Enter":e.preventDefault(),s&&s.click();break;case"Escape":m(),u.blur();break}}})();
